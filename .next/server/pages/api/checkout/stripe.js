"use strict";(()=>{var e={};e.id=3513,e.ids=[3513],e.modules={4722:e=>{e.exports=require("next-auth/react")},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return s}});var s=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},33480:(e,t,s)=>{e.exports=s(75600)},45852:(e,t,s)=>{s.r(t),s.d(t,{config:()=>p,default:()=>d,routeModule:()=>g});var a={};s.r(a),s.d(a,{default:()=>l});var n=s(33480),r=s(8667),o=s(86435),i=s(4722),u=s(87366),c=s(75217);async function l(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"Method not allowed"});try{let s,a=await (0,i.getSession)({req:e}),n=a?.user?.id,{sessionId:r}=e.cookies;if(!n&&!r)return t.status(401).json({success:!1,message:"Authentication required"});if(s=n?await (0,c.query)("SELECT id FROM carts WHERE user_id = $1",[n]):await (0,c.query)("SELECT id FROM carts WHERE session_id = $1",[r]),0===s.rows.length)return t.status(400).json({success:!1,message:"Cart not found"});let o=s.rows[0].id,l=await (0,c.query)(`
      SELECT ci.id, ci.quantity, p.id as product_id, p.name, p.price,
             p.discount_percentage, p.image_url, p.slug
      FROM cart_items ci
      JOIN products p ON ci.product_id = p.id
      WHERE ci.cart_id = $1
    `,[o]);if(0===l.rows.length)return t.status(400).json({success:!1,message:"Cart is empty"});let d=l.rows.map(e=>{let t=parseFloat(e.price),s=parseFloat(e.discount_percentage||0);return{price_data:{currency:"usd",product_data:{name:e.name,images:e.image_url?[e.image_url]:[]},unit_amount:Math.round(100*(s>0?t*(1-s/100):t))},quantity:e.quantity}}),{success_url:p=`${process.env.NEXTAUTH_URL}/checkout/success`,cancel_url:g=`${process.env.NEXTAUTH_URL}/checkout/cancel`}=e.body,y=await u.Ay.checkout.sessions.create({payment_method_types:["card"],billing_address_collection:"required",shipping_address_collection:{allowed_countries:["US","CA","GB","AU"]},line_items:d,mode:"payment",success_url:p,cancel_url:g,metadata:{cart_id:o,user_id:n||"",session_id:r||""},shipping_options:[{shipping_rate_data:{type:"fixed_amount",fixed_amount:{amount:0,currency:"usd"},display_name:"Free shipping",delivery_estimate:{minimum:{unit:"business_day",value:5},maximum:{unit:"business_day",value:7}}}},{shipping_rate_data:{type:"fixed_amount",fixed_amount:{amount:1500,currency:"usd"},display_name:"Express shipping",delivery_estimate:{minimum:{unit:"business_day",value:1},maximum:{unit:"business_day",value:2}}}}]});return t.status(200).json({success:!0,sessionId:y.id,url:y.url})}catch(e){return console.error("Stripe checkout error:",e),t.status(500).json({success:!1,message:"Error creating checkout session"})}}let d=(0,o.M)(a,"default"),p=(0,o.M)(a,"config"),g=new n.PagesAPIRouteModule({definition:{kind:r.A.PAGES_API,page:"/api/checkout/stripe",pathname:"/api/checkout/stripe",bundlePath:"",filename:""},userland:a})},75217:(e,t,s)=>{s.r(t),s.d(t,{createUser:()=>o,default:()=>m,getCategories:()=>p,getCategoryBySlug:()=>d,getConnection:()=>n,getProductBySlug:()=>y,getProducts:()=>g,getUserByEmail:()=>i,getUserById:()=>u,pool:()=>l,query:()=>a,transaction:()=>r,updateUser:()=>c});let a=async(e,t=[])=>(console.log(`Database query: ${e}`,t),{rows:[],rowCount:0}),n=async()=>(console.log("Getting database connection"),{query:a,release:()=>console.log("Connection released")}),r=async e=>{console.log("Starting database transaction");let t=await n();try{await t.query("BEGIN");let s=await e(t);return await t.query("COMMIT"),s}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}},o=async e=>(console.log("Creating user:",e),{id:"mock-user-id",...e}),i=async e=>(console.log("Getting user by email:",e),null),u=async e=>(console.log("Getting user by ID:",e),null),c=async(e,t)=>(console.log("Updating user:",e,t),{id:e,...t}),l={query:async(e,t=[])=>(console.log(`Pool query: ${e}`,t),{rows:[],rowCount:0}),connect:async()=>(console.log("Pool connection established"),{query:async(e,t=[])=>(console.log(`Connection query: ${e}`,t),{rows:[],rowCount:0}),release:()=>console.log("Connection released")})},d=async e=>(console.log(`Getting category by slug: ${e}`),{id:1,name:"iPhone Parts",slug:e,description:"High-quality iPhone replacement parts"}),p=async()=>(console.log("Getting all categories"),[{id:1,name:"iPhone Parts",slug:"iphone-parts"},{id:2,name:"Samsung Parts",slug:"samsung-parts"},{id:3,name:"iPad Parts",slug:"ipad-parts"},{id:4,name:"Tools",slug:"tools"}]),g=async(e={})=>(console.log("Getting products with filters:",e),[{id:1,name:"iPhone 15 Pro Screen",slug:"iphone-15-pro-screen",price:299.99,category:"iPhone Parts"},{id:2,name:"Samsung S24 Battery",slug:"samsung-s24-battery",price:89.99,category:"Samsung Parts"}]),y=async e=>(console.log(`Getting product by slug: ${e}`),{id:1,name:"iPhone 15 Pro Screen",slug:e,price:299.99,description:"High-quality OLED screen replacement for iPhone 15 Pro",category:"iPhone Parts"}),m={query:a,getConnection:n,transaction:r,createUser:o,getUserByEmail:i,getUserById:u,updateUser:c,pool:l,getCategoryBySlug:d,getCategories:p,getProducts:g,getProductBySlug:y}},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},86435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},87366:(e,t,s)=>{let a;s.d(t,{Dt:()=>o,Ay:()=>i});let n=require("@stripe/stripe-js"),r={locale:"en-AE",vatRate:.05},o=e=>{let t=e*r.vatRate;return{subtotal:e,vat:t,total:e+t,vatRate:100*r.vatRate}},i=()=>(a||(a=(0,n.loadStripe)("pk_live_REPLACE_WITH_LIVE_STRIPE_KEY",{locale:r.locale})),a)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=45852);module.exports=s})();
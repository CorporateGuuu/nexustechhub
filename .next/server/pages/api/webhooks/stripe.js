"use strict";(()=>{var e={};e.id=4105,e.ids=[4105],e.modules={84217:e=>{e.exports=require("micro")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},36090:e=>{e.exports=import("stripe")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},59616:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>l,default:()=>d,routeModule:()=>u});var r=s(71802),o=s(47153),n=s(56249),i=s(25806),c=e([i]);i=(c.then?(await c)():c)[0];let d=(0,n.l)(i,"default"),l=(0,n.l)(i,"config"),u=new r.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/webhooks/stripe",pathname:"/api/webhooks/stripe",bundlePath:"",filename:""},userland:i});a()}catch(e){a(e)}})},51004:(e,t,s)=>{s.r(t),s.d(t,{createUser:()=>n,default:()=>m,getCategories:()=>p,getCategoryBySlug:()=>u,getConnection:()=>r,getProductBySlug:()=>y,getProducts:()=>g,getUserByEmail:()=>i,getUserById:()=>c,pool:()=>l,query:()=>a,transaction:()=>o,updateUser:()=>d});let a=async(e,t=[])=>(console.log(`Database query: ${e}`,t),{rows:[],rowCount:0}),r=async()=>(console.log("Getting database connection"),{query:a,release:()=>console.log("Connection released")}),o=async e=>{console.log("Starting database transaction");let t=await r();try{await t.query("BEGIN");let s=await e(t);return await t.query("COMMIT"),s}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}},n=async e=>(console.log("Creating user:",e),{id:"mock-user-id",...e}),i=async e=>(console.log("Getting user by email:",e),null),c=async e=>(console.log("Getting user by ID:",e),null),d=async(e,t)=>(console.log("Updating user:",e,t),{id:e,...t}),l={query:async(e,t=[])=>(console.log(`Pool query: ${e}`,t),{rows:[],rowCount:0}),connect:async()=>(console.log("Pool connection established"),{query:async(e,t=[])=>(console.log(`Connection query: ${e}`,t),{rows:[],rowCount:0}),release:()=>console.log("Connection released")})},u=async e=>(console.log(`Getting category by slug: ${e}`),{id:1,name:"iPhone Parts",slug:e,description:"High-quality iPhone replacement parts"}),p=async()=>(console.log("Getting all categories"),[{id:1,name:"iPhone Parts",slug:"iphone-parts"},{id:2,name:"Samsung Parts",slug:"samsung-parts"},{id:3,name:"iPad Parts",slug:"ipad-parts"},{id:4,name:"Tools",slug:"tools"}]),g=async(e={})=>(console.log("Getting products with filters:",e),[{id:1,name:"iPhone 15 Pro Screen",slug:"iphone-15-pro-screen",price:299.99,category:"iPhone Parts"},{id:2,name:"Samsung S24 Battery",slug:"samsung-s24-battery",price:89.99,category:"Samsung Parts"}]),y=async e=>(console.log(`Getting product by slug: ${e}`),{id:1,name:"iPhone 15 Pro Screen",slug:e,price:299.99,description:"High-quality OLED screen replacement for iPhone 15 Pro",category:"iPhone Parts"}),m={query:a,getConnection:r,transaction:o,createUser:n,getUserByEmail:i,getUserById:c,updateUser:d,pool:l,getCategoryBySlug:u,getCategories:p,getProducts:g,getProductBySlug:y}},25806:(e,t,s)=>{s.a(e,async(e,a)=>{try{s.r(t),s.d(t,{config:()=>d,default:()=>c});var r=s(84217),o=s(36090),n=s(51004),i=e([o]);o=(i.then?(await i)():i)[0];let d={api:{bodyParser:!1}};async function c(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"Method not allowed"});let s=new o.default(process.env.STRIPE_SECRET_KEY),a=process.env.STRIPE_WEBHOOK_SECRET;if(!a)return t.status(500).json({success:!1,message:"Stripe webhook secret is not set"});try{let o;let i=await (0,r.buffer)(e),c=e.headers["stripe-signature"];try{o=s.webhooks.constructEvent(i,c,a)}catch(e){return console.error(`Webhook signature verification failed: ${e.message}`),t.status(400).json({success:!1,message:`Webhook Error: ${e.message}`})}if("checkout.session.completed"===o.type){let e=o.data.object,{cart_id:s,user_id:a}=e.metadata,r=await (0,n.query)(`
        SELECT ci.product_id, ci.quantity, p.name, p.price, p.discount_percentage
        FROM cart_items ci
        JOIN products p ON ci.product_id = p.id
        WHERE ci.cart_id = $1
      `,[s]);if(0===r.rows.length)return t.status(400).json({success:!1,message:"Cart is empty"});let i=0,c=r.rows.map(e=>{let t=parseFloat(e.price),s=parseFloat(e.discount_percentage||0),a=(s>0?t*(1-s/100):t)*e.quantity;return i+=a,{product_id:e.product_id,product_name:e.name,product_price:t,quantity:e.quantity,discount_percentage:s,total_price:a}}),d=e.shipping_cost?e.shipping_cost.amount_total/100:0;i+=d;let l=function(){let e=new Date().getTime().toString().slice(-8),t=Math.floor(1e4*Math.random()).toString().padStart(4,"0");return`ORD-${e}-${t}`}(),u={name:e.customer_details.name,email:e.customer_details.email,phone:e.customer_details.phone||""},p=e.shipping_details?{name:e.shipping_details.name,address:{line1:e.shipping_details.address.line1,line2:e.shipping_details.address.line2||"",city:e.shipping_details.address.city,state:e.shipping_details.address.state,postal_code:e.shipping_details.address.postal_code,country:e.shipping_details.address.country},phone:e.shipping_details.phone||""}:null,g=p?{name:p.name,email:u.email,phone:p.phone||u.phone,address:p.address.line1+(p.address.line2?", "+p.address.line2:""),city:p.address.city,state:p.address.state,zip:p.address.postal_code,country:p.address.country}:null,y={name:e.customer_details.name,email:e.customer_details.email,phone:e.customer_details.phone||"",address:e.customer_details.address.line1+(e.customer_details.address.line2?", "+e.customer_details.address.line2:""),city:e.customer_details.address.city,state:e.customer_details.address.state,zip:e.customer_details.address.postal_code,country:e.customer_details.address.country},m={type:e.payment_method_types[0],payment_intent:e.payment_intent,amount:e.amount_total/100,currency:e.currency,status:e.payment_status},_=await n.query.getClient();try{await _.query("BEGIN");let t=(await _.query(`
          INSERT INTO orders (
            user_id, order_number, status, total_amount,
            shipping_address, billing_address, payment_method,
            payment_status, shipping_method, shipping_cost
          )
          VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
          RETURNING id
        `,[a||null,l,"processing",i,JSON.stringify(g),JSON.stringify(y),JSON.stringify(m),e.payment_status,e.shipping_cost?e.shipping_cost.shipping_rate.display_name:"Free shipping",d])).rows[0].id;for(let e of c)await _.query(`
            INSERT INTO order_items (
              order_id, product_id, product_name, product_price,
              quantity, discount_percentage, total_price
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7)
          `,[t,e.product_id,e.product_name,e.product_price,e.quantity,e.discount_percentage,e.total_price]);await _.query(`
          INSERT INTO order_status_history (order_id, status, notes)
          VALUES ($1, $2, $3)
        `,[t,"processing","Payment completed via Stripe"]),await _.query("DELETE FROM cart_items WHERE cart_id = $1",[s]),await _.query("COMMIT")}catch(e){throw await _.query("ROLLBACK"),console.error("Error processing order:",e),e}finally{_.release()}}return t.status(200).json({received:!0})}catch(e){return console.error("Stripe webhook error:",e),t.status(500).json({success:!1,message:"Error processing webhook"})}}a()}catch(e){a(e)}})},47153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},71802:(e,t,s)=>{e.exports=s(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var s=t(t.s=59616);module.exports=s})();
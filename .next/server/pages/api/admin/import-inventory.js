"use strict";(()=>{var e={};e.id=808,e.ids=[808],e.modules={14280:e=>{e.exports=require("csv-parser")},41649:e=>{e.exports=require("next-auth/react")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6302:e=>{e.exports=require("xlsx")},92048:e=>{e.exports=require("fs")},36705:e=>{e.exports=import("formidable")},8678:e=>{e.exports=import("pg")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},25202:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>l,routeModule:()=>d});var s=r(71802),i=r(47153),o=r(56249),n=r(19375),c=e([n]);n=(c.then?(await c)():c)[0];let l=(0,o.l)(n,"default"),u=(0,o.l)(n,"config"),d=new s.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/admin/import-inventory",pathname:"/api/admin/import-inventory",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},19375:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>w,default:()=>g});var s=r(41649),i=r(36705),o=r(92048),n=r.n(o),c=r(14280),l=r.n(c),u=r(8678),d=r(6302),p=r.n(d),m=e([i,u]);[i,u]=m.then?(await m)():m;let w={api:{bodyParser:!1}},N=new u.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}});async function g(e,t){if("POST"!==e.method)return t.status(405).json({success:!1,message:"Method not allowed"});let r=await (0,s.getSession)({req:e});if(!r||!r.user.isAdmin)return t.status(401).json({success:!1,message:"Unauthorized"});try{let r=new i.default.IncomingForm;r.keepExtensions=!0;let[a,s]=await new Promise((t,a)=>{r.parse(e,(e,r,s)=>{e&&a(e),t([r,s])})}),o=s.file,n=a.source,c=JSON.parse(a.mapping);if(!o)return t.status(400).json({success:!1,message:"No file uploaded"});let l=[],u=o.filepath,d=o.originalFilename.split(".").pop().toLowerCase();if("csv"===d)l=await f(u,c,n);else{if("xlsx"!==d&&"xls"!==d)return t.status(400).json({success:!1,message:"Unsupported file format"});l=await E(u,c,n)}let p=await y(l);return t.status(200).json({success:!0,message:`Successfully processed ${l.length} products`,stats:p})}catch(e){return console.error("Error importing inventory:",e),t.status(500).json({success:!1,message:e.message||"Failed to import inventory"})}}async function f(e,t,r){let a=[];return new Promise((s,i)=>{n().createReadStream(e).pipe(l()()).on("data",e=>{let s=h(e,t,r);s&&a.push(s)}).on("end",()=>{s(a)}).on("error",e=>{i(e)})})}async function E(e,t,r){let a=[];try{if(n().statSync(e).size>10485760)throw Error("File size exceeds 10MB limit");let s=p().readFile(e,{cellDates:!0,cellNF:!1,cellText:!1,cellHTML:!1,sheetStubs:!1,bookDeps:!1,bookFiles:!1,bookProps:!1,bookSheets:!1,bookVBA:!1});if(!s.SheetNames||0===s.SheetNames.length)throw Error("No sheets found in Excel file");let i=s.SheetNames[0],o=s.Sheets[i];if(!o)throw Error("Unable to read worksheet");let c=p().utils.sheet_to_json(o,{header:1,defval:"",blankrows:!1,raw:!1});return c.slice(0,1e4).forEach((e,s)=>{if(0===s)return;let i={};c[0].forEach((t,r)=>{i[t]=e[r]||""});let o=h(i,t,r);o&&a.push(o)}),a}catch(e){throw console.error("Error parsing Excel file:",e),Error(`Failed to parse Excel file: ${e.message}`)}finally{try{n().unlinkSync(e)}catch(e){console.error("Error cleaning up file:",e)}}}function h(e,t,r){var a;let s=e=>"string"!=typeof e?String(e||""):e.replace(/[<>]/g,"").replace(/['"]/g,"").trim().substring(0,1e3);return{sku:s(e[t.sku]),name:s(e[t.name]),description:s(e[t.description]),price:((e,t=0)=>{let r=parseFloat(e);return isNaN(r)||!isFinite(r)?t:Math.max(0,r)})(e[t.price]),stock:((e,t=0)=>{let r=parseInt(e);return isNaN(r)||!isFinite(r)?t:Math.max(0,r)})(e[t.stock]),category:s(e[t.category]),brand:s(e[t.brand]),images:(a=e[t.images])?("string"==typeof a?a.split(","):[a]).map(e=>s(e)).filter(e=>e.length>0).slice(0,10):[]}}async function y(e){let t={imported:0,updated:0,skipped:0,errors:0},r=await N.connect();try{for(let a of(await r.query("BEGIN"),e))try{if(!a.sku||!a.name){t.skipped++;continue}let e=await r.query("SELECT id FROM products WHERE sku = $1",[a.sku]),s=null;if(a.category){let e=await r.query("SELECT id FROM categories WHERE name = $1",[a.category]);if(e.rows.length>0)s=e.rows[0].id;else{let e=a.category.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");s=(await r.query(`INSERT INTO categories (name, slug, created_at, updated_at)
               VALUES ($1, $2, NOW(), NOW())
               RETURNING id`,[a.category,e])).rows[0].id}}if(e.rows.length>0){if(await r.query(`UPDATE products
             SET name = $1, description = $2, price = $3, stock = $4,
                 category_id = $5, brand = $6, updated_at = NOW()
             WHERE sku = $7`,[a.name,a.description,a.price,a.stock,s,a.brand,a.sku]),a.images&&a.images.length>0){await r.query("DELETE FROM product_images WHERE product_id = $1",[e.rows[0].id]);for(let t=0;t<a.images.length;t++)await r.query(`INSERT INTO product_images (product_id, image_url, display_order, created_at, updated_at)
                 VALUES ($1, $2, $3, NOW(), NOW())`,[e.rows[0].id,a.images[t],t+1])}t.updated++}else{let e=await r.query(`INSERT INTO products (sku, name, description, price, stock, category_id, brand, created_at, updated_at)
             VALUES ($1, $2, $3, $4, $5, $6, $7, NOW(), NOW())
             RETURNING id`,[a.sku,a.name,a.description,a.price,a.stock,s,a.brand]);if(a.images&&a.images.length>0)for(let t=0;t<a.images.length;t++)await r.query(`INSERT INTO product_images (product_id, image_url, display_order, created_at, updated_at)
                 VALUES ($1, $2, $3, NOW(), NOW())`,[e.rows[0].id,a.images[t],t+1]);t.imported++}}catch(e){console.error("Error importing product:",e,a),t.errors++}return await r.query("COMMIT"),t}catch(e){throw await r.query("ROLLBACK"),e}finally{r.release()}}a()}catch(e){a(e)}})},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=25202);module.exports=r})();
"use strict";(()=>{var e={};e.id=7435,e.ids=[7435],e.modules={5486:e=>{e.exports=require("bcrypt")},16382:e=>{e.exports=require("next-auth/providers/credentials")},17067:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{config:()=>x,default:()=>f});var s=t(65542),i=t(52043),o=t(67313),n=t(29021),c=t.n(n),l=t(67048),u=t.n(l),d=t(64939),p=t(78608),g=t.n(p),m=e([o,d]);[o,d]=m.then?(await m)():m;let x={api:{bodyParser:!1}},N=new d.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}});async function f(e,r){if("POST"!==e.method)return r.status(405).json({success:!1,message:"Method not allowed"});let t=await (0,s.getServerSession)(e,r,i.authOptions);if(!t||!t.user.isAdmin)return r.status(401).json({success:!1,message:"Unauthorized"});try{let t=new o.default.IncomingForm;t.keepExtensions=!0;let[a,s]=await new Promise((r,a)=>{t.parse(e,(e,t,s)=>{e&&a(e),r([t,s])})}),i=s.file,n=a.source,c=JSON.parse(a.mapping);if(!i)return r.status(400).json({success:!1,message:"No file uploaded"});let l=[],u=i.filepath,d=i.originalFilename.split(".").pop().toLowerCase();if("csv"===d)l=await h(u,c,n);else{if("xlsx"!==d&&"xls"!==d)return r.status(400).json({success:!1,message:"Unsupported file format"});l=await w(u,c,n)}let p=await E(l);return r.status(200).json({success:!0,message:`Successfully processed ${l.length} products`,stats:p})}catch(e){return console.error("Error importing inventory:",e),r.status(500).json({success:!1,message:e.message||"Failed to import inventory"})}}async function h(e,r,t){let a=[];return new Promise((s,i)=>{c().createReadStream(e).pipe(u()()).on("data",e=>{let s=y(e,r,t);s&&a.push(s)}).on("end",()=>{s(a)}).on("error",e=>{i(e)})})}async function w(e,r,t){let a=[];try{if(c().statSync(e).size>0xa00000)throw Error("File size exceeds 10MB limit");let s=new(g()).Workbook;if(await s.xlsx.readFile(e),!s.worksheets||0===s.worksheets.length)throw Error("No sheets found in Excel file");let i=s.worksheets[0];if(!i)throw Error("Unable to read worksheet");let o=[];if(i.eachRow((e,r)=>{let t=[];e.eachCell((e,r)=>{t[r-1]=String(e.value||"")}),o.push(t)}),0===o.length)throw Error("No data found in Excel file");let n=o.slice(0,1e4),l=n[0];return n.forEach((e,s)=>{if(0===s)return;let i={};l.forEach((r,t)=>{i[r]=e[t]||""});let o=y(i,r,t);o&&a.push(o)}),a}catch(e){throw console.error("Error parsing Excel file:",e),Error(`Failed to parse Excel file: ${e.message}`)}finally{try{c().unlinkSync(e)}catch(e){console.error("Error cleaning up file:",e)}}}function y(e,r,t){var a;let s=e=>"string"!=typeof e?String(e||""):e.replace(/[<>]/g,"").replace(/['"]/g,"").trim().substring(0,1e3);return{sku:s(e[r.sku]),name:s(e[r.name]),description:s(e[r.description]),price:((e,r=0)=>{let t=parseFloat(e);return isNaN(t)||!isFinite(t)?r:Math.max(0,t)})(e[r.price]),stock:((e,r=0)=>{let t=parseInt(e);return isNaN(t)||!isFinite(t)?r:Math.max(0,t)})(e[r.stock]),category:s(e[r.category]),brand:s(e[r.brand]),images:(a=e[r.images])?("string"==typeof a?a.split(","):[a]).map(e=>s(e)).filter(e=>e.length>0).slice(0,10):[]}}async function E(e){let r={imported:0,updated:0,skipped:0,errors:0},t=await N.connect();try{for(let a of(await t.query("BEGIN"),e))try{if(!a.sku||!a.name){r.skipped++;continue}let e=await t.query("SELECT id FROM products WHERE sku = $1",[a.sku]),s=null;if(a.category){let e=await t.query("SELECT id FROM categories WHERE name = $1",[a.category]);if(e.rows.length>0)s=e.rows[0].id;else{let e=a.category.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");s=(await t.query(`INSERT INTO categories (name, slug, created_at, updated_at)
               VALUES ($1, $2, NOW(), NOW())
               RETURNING id`,[a.category,e])).rows[0].id}}if(e.rows.length>0){if(await t.query(`UPDATE products
             SET name = $1, description = $2, price = $3, stock = $4,
                 category_id = $5, brand = $6, updated_at = NOW()
             WHERE sku = $7`,[a.name,a.description,a.price,a.stock,s,a.brand,a.sku]),a.images&&a.images.length>0){await t.query("DELETE FROM product_images WHERE product_id = $1",[e.rows[0].id]);for(let r=0;r<a.images.length;r++)await t.query(`INSERT INTO product_images (product_id, image_url, display_order, created_at, updated_at)
                 VALUES ($1, $2, $3, NOW(), NOW())`,[e.rows[0].id,a.images[r],r+1])}r.updated++}else{let e=await t.query(`INSERT INTO products (sku, name, description, price, stock, category_id, brand, created_at, updated_at)
             VALUES ($1, $2, $3, $4, $5, $6, $7, NOW(), NOW())
             RETURNING id`,[a.sku,a.name,a.description,a.price,a.stock,s,a.brand]);if(a.images&&a.images.length>0)for(let r=0;r<a.images.length;r++)await t.query(`INSERT INTO product_images (product_id, image_url, display_order, created_at, updated_at)
                 VALUES ($1, $2, $3, NOW(), NOW())`,[e.rows[0].id,a.images[r],r+1]);r.imported++}}catch(e){console.error("Error importing product:",e,a),r.errors++}return await t.query("COMMIT"),r}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}}a()}catch(e){a(e)}})},21572:e=>{e.exports=require("nodemailer")},29021:e=>{e.exports=require("fs")},50804:e=>{e.exports=require("next-auth/providers/email")},51714:(e,r,t)=>{t.a(e,async(e,a)=>{try{t.r(r),t.d(r,{config:()=>u,default:()=>l,routeModule:()=>d});var s=t(33480),i=t(8667),o=t(86435),n=t(17067),c=e([n]);n=(c.then?(await c)():c)[0];let l=(0,o.M)(n,"default"),u=(0,o.M)(n,"config"),d=new s.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/admin/import-inventory",pathname:"/api/admin/import-inventory",bundlePath:"",filename:""},userland:n});a()}catch(e){a(e)}})},64939:e=>{e.exports=import("pg")},65542:e=>{e.exports=require("next-auth")},67048:e=>{e.exports=require("csv-parser")},67313:e=>{e.exports=import("formidable")},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},77851:e=>{e.exports=require("next-auth/providers/google")},78608:e=>{e.exports=require("exceljs")}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[2622],()=>t(51714));module.exports=a})();
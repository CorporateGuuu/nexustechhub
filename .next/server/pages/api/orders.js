"use strict";(()=>{var e={};e.id=5244,e.ids=[5244],e.modules={4722:e=>{e.exports=require("next-auth/react")},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},22418:e=>{e.exports=import("uuid")},33480:(e,t,r)=>{e.exports=r(75600)},54515:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{config:()=>l,default:()=>c,routeModule:()=>d});var a=r(33480),n=r(8667),o=r(86435),i=r(57513),u=e([i]);i=(u.then?(await u)():u)[0];let c=(0,o.M)(i,"default"),l=(0,o.M)(i,"config"),d=new a.PagesAPIRouteModule({definition:{kind:n.A.PAGES_API,page:"/api/orders",pathname:"/api/orders",bundlePath:"",filename:""},userland:i});s()}catch(e){s(e)}})},57513:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{default:()=>u});var a=r(4722),n=r(75217),o=r(22418),i=e([o]);async function u(e,t){let r=await (0,a.getSession)({req:e});if(!r?.user?.id)return t.status(401).json({success:!1,message:"Authentication required"});switch(e.method){case"GET":return c(e,t,r.user.id);case"POST":return l(e,t,r.user.id);default:return t.status(405).json({success:!1,message:"Method not allowed"})}}async function c(e,t,r){try{let e=(await (0,n.query)(`
      SELECT id, order_number, status, total_amount, created_at
      FROM orders
      WHERE user_id = $1
      ORDER BY created_at DESC
    `,[r])).rows;return t.status(200).json({success:!0,orders:e})}catch(e){return console.error("Error getting orders:",e),t.status(500).json({success:!1,message:"Error getting orders"})}}async function l(e,t,r){let s=await n.query.getClient();try{let{items:a,shipping_address:n,billing_address:o,payment_method:i,notes:u,total_amount:c}=e.body;if(!a||!a.length||!n||!o||!i)return t.status(400).json({success:!1,message:"Missing required fields"});let l=function(){let e=new Date().getTime().toString().slice(-8),t=Math.floor(1e4*Math.random()).toString().padStart(4,"0");return`ORD-${e}-${t}`}();await s.query("BEGIN");let d=(await s.query(`
      INSERT INTO orders (
        user_id, order_number, status, total_amount,
        shipping_address, billing_address, payment_method,
        payment_status, notes
      )
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
      RETURNING id, order_number, status, total_amount, created_at
    `,[r,l,"pending",c,JSON.stringify(n),JSON.stringify(o),JSON.stringify(i),"pending",u||""])).rows[0];for(let e of a){let t=await s.query("SELECT name, price, discount_percentage FROM products WHERE id = $1",[e.product_id]);if(0===t.rows.length)throw Error(`Product not found: ${e.product_id}`);let r=t.rows[0],a=parseFloat(r.price),n=parseFloat(r.discount_percentage||0),o=n>0?a*(1-n/100):a;await s.query(`
        INSERT INTO order_items (
          order_id, product_id, product_name, product_price,
          quantity, discount_percentage, total_price
        )
        VALUES ($1, $2, $3, $4, $5, $6, $7)
      `,[d.id,e.product_id,r.name,a,e.quantity,n,parseFloat((o*e.quantity).toFixed(2))])}await s.query(`
      INSERT INTO order_status_history (order_id, status, notes)
      VALUES ($1, $2, $3)
    `,[d.id,"pending","Order created"]);let g=await s.query("SELECT id FROM carts WHERE user_id = $1",[r]);if(g.rows.length>0){let e=g.rows[0].id;await s.query("DELETE FROM cart_items WHERE cart_id = $1",[e])}return await s.query("COMMIT"),t.status(201).json({success:!0,order:d,message:"Order created successfully"})}catch(e){return await s.query("ROLLBACK"),console.error("Error creating order:",e),t.status(500).json({success:!1,message:"Error creating order"})}finally{s.release()}}o=(i.then?(await i)():i)[0],s()}catch(e){s(e)}})},75217:(e,t,r)=>{r.r(t),r.d(t,{createUser:()=>o,default:()=>m,getCategories:()=>g,getCategoryBySlug:()=>d,getConnection:()=>a,getProductBySlug:()=>p,getProducts:()=>y,getUserByEmail:()=>i,getUserById:()=>u,pool:()=>l,query:()=>s,transaction:()=>n,updateUser:()=>c});let s=async(e,t=[])=>(console.log(`Database query: ${e}`,t),{rows:[],rowCount:0}),a=async()=>(console.log("Getting database connection"),{query:s,release:()=>console.log("Connection released")}),n=async e=>{console.log("Starting database transaction");let t=await a();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}},o=async e=>(console.log("Creating user:",e),{id:"mock-user-id",...e}),i=async e=>(console.log("Getting user by email:",e),null),u=async e=>(console.log("Getting user by ID:",e),null),c=async(e,t)=>(console.log("Updating user:",e,t),{id:e,...t}),l={query:async(e,t=[])=>(console.log(`Pool query: ${e}`,t),{rows:[],rowCount:0}),connect:async()=>(console.log("Pool connection established"),{query:async(e,t=[])=>(console.log(`Connection query: ${e}`,t),{rows:[],rowCount:0}),release:()=>console.log("Connection released")})},d=async e=>(console.log(`Getting category by slug: ${e}`),{id:1,name:"iPhone Parts",slug:e,description:"High-quality iPhone replacement parts"}),g=async()=>(console.log("Getting all categories"),[{id:1,name:"iPhone Parts",slug:"iphone-parts"},{id:2,name:"Samsung Parts",slug:"samsung-parts"},{id:3,name:"iPad Parts",slug:"ipad-parts"},{id:4,name:"Tools",slug:"tools"}]),y=async(e={})=>(console.log("Getting products with filters:",e),[{id:1,name:"iPhone 15 Pro Screen",slug:"iphone-15-pro-screen",price:299.99,category:"iPhone Parts"},{id:2,name:"Samsung S24 Battery",slug:"samsung-s24-battery",price:89.99,category:"Samsung Parts"}]),p=async e=>(console.log(`Getting product by slug: ${e}`),{id:1,name:"iPhone 15 Pro Screen",slug:e,price:299.99,description:"High-quality OLED screen replacement for iPhone 15 Pro",category:"iPhone Parts"}),m={query:s,getConnection:a,transaction:n,createUser:o,getUserByEmail:i,getUserById:u,updateUser:c,pool:l,getCategoryBySlug:d,getCategories:g,getProducts:y,getProductBySlug:p}},75600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},86435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=54515);module.exports=r})();